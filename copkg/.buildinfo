#product-info {
    product-name: "CoApp for Visual Studio";
    original-source-location: "git@github.com:henjuv/coapp-vse.git";
    original-source-website: "https://github.com/henjuv/coapp-vse";
    license: "Apache2.0";
    packager: "henrik juvonen <henjuv@utu.fi>";
}

build {
	uses: release;
}

release {
    set: cfg = "Release";
    uses: anycpu;
}

package {
    uses: sign;
    build-command: @"
		cd copkg
        autopackage coapp.vse.autopkg || goto failed
		erase /Q *.wixpdb
    ";
}

install {
    set: cfg = "Release";
    uses: package;
    build-command: @"
		for /F %%G in ('dir /s /b /o-n  coapp.vse*.msi') do ( 
			coapp install %%G
			goto :eof
		)
    ";
}

sign {
    set: cfg = "Release";
    set: bin_path = @"src\VsExtension\bin\${cfg}\";
    
    uses: release;
    
    build-command: @"
        simplesigner --nologo  --sign --strong-name ""${bin_path}CoApp.VisualStudio.Core.dll"" ""${bin_path}CoApp.VisualStudio.Dialog.dll"" ""${bin_path}CoApp.VisualStudio.DialogServices.dll"" ""${bin_path}CoApp.VisualStudio.Options.dll"" ""${bin_path}CoApp.VisualStudio.VsCore.dll"" ""${bin_path}CoApp.VisualStudio.Tools.dll""
    ";
}

anycpu {
	compiler: vc10;
	set: bin_path = @"src\VsExtension\bin\${cfg}\";
	
    targets: { 
		"${bin_path}CoApp.VisualStudio.Core.dll",
		"${bin_path}CoApp.VisualStudio.Dialog.dll",
		"${bin_path}CoApp.VisualStudio.DialogServices.dll",
		"${bin_path}CoApp.VisualStudio.Options.dll",
		"${bin_path}CoApp.VisualStudio.VsCore.dll",
		"${bin_path}CoApp.VisualStudio.Tools.dll",
    };

    build-command: @"
		cscript //e:jscript copkg\increment-build-version.js
        msbuild /p:Configuration=${cfg} coapp-vse.sln /verbosity:q /nologo || goto failed
    ";
}

clean {
    clean-command: @"
        rmdir /s /q output intermediate bin obj > nul 2>&1
        for /d %%v in (*) do if exist %%v\obj rmdir /s /q %%v\obj        
        for /d %%v in (*) do if exist %%v\bin rmdir /s /q %%v\bin
    ";
}